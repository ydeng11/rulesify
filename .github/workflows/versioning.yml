name: Version Management

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - release
          - next-dev
      release_version:
        description: 'Release version (e.g., 0.3.0) - only for release action'
        required: false
        type: string
      next_version:
        description: 'Next development version (e.g., 0.3.1) - only for next-dev action'
        required: false
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    name: Release Version
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'release'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Determine release version
        id: release_version
        run: |
          if [ -n "${{ github.event.inputs.release_version }}" ]; then
            RELEASE_VERSION="${{ github.event.inputs.release_version }}"
          else
            # Auto-determine from current version and latest git tag
            CURRENT="${{ steps.current_version.outputs.current_version }}"

            # Get latest release tag (format: v0.3.0)
            LATEST_TAG=$(git tag -l "v*" | sort -V | tail -1 || echo "")

            if [ -z "$LATEST_TAG" ]; then
              # No tags exist, use current version
              RELEASE_VERSION="$CURRENT"
              echo "No existing tags found, using current version: $RELEASE_VERSION"
            else
              # Extract version from tag (remove 'v' prefix)
              LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')

              # Compare versions and use the higher one, or increment patch if equal
              # Simple version comparison for semantic versioning
              CURRENT_MAJOR=$(echo "$CURRENT" | cut -d. -f1)
              CURRENT_MINOR=$(echo "$CURRENT" | cut -d. -f2)
              CURRENT_PATCH=$(echo "$CURRENT" | cut -d. -f3)

              LATEST_MAJOR=$(echo "$LATEST_VERSION" | cut -d. -f1)
              LATEST_MINOR=$(echo "$LATEST_VERSION" | cut -d. -f2)
              LATEST_PATCH=$(echo "$LATEST_VERSION" | cut -d. -f3)

              # If current version is higher or equal to latest, use it
              # Otherwise increment patch from latest
              if [ "$CURRENT_MAJOR" -gt "$LATEST_MAJOR" ] || \
                 ([ "$CURRENT_MAJOR" -eq "$LATEST_MAJOR" ] && [ "$CURRENT_MINOR" -gt "$LATEST_MINOR" ]) || \
                 ([ "$CURRENT_MAJOR" -eq "$LATEST_MAJOR" ] && [ "$CURRENT_MINOR" -eq "$LATEST_MINOR" ] && [ "$CURRENT_PATCH" -ge "$LATEST_PATCH" ]); then
                RELEASE_VERSION="$CURRENT"
                echo "Current version ($CURRENT) is >= latest tag ($LATEST_VERSION), using current"
              else
                # Increment patch version from latest tag
                LATEST_PATCH=$((LATEST_PATCH + 1))
                RELEASE_VERSION="${LATEST_MAJOR}.${LATEST_MINOR}.${LATEST_PATCH}"
                echo "Auto-incrementing from latest tag ($LATEST_VERSION) to: $RELEASE_VERSION"
              fi
            fi
          fi
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $RELEASE_VERSION"

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Set release version
        run: |
          RELEASE="${{ steps.release_version.outputs.release_version }}"
          # Update version in Cargo.toml
          sed -i.bak "s/^version = \".*\"/version = \"$RELEASE\"/" Cargo.toml
          rm Cargo.toml.bak

      - name: Build release artifact
        run: cargo build --release

      - name: Commit release version
        run: |
          git add Cargo.toml Cargo.lock
          git commit -m "[RELEASE] ${{ steps.release_version.outputs.release_version }}"
          git tag -a "v${{ steps.release_version.outputs.release_version }}" -m "Release version ${{ steps.release_version.outputs.release_version }}"

      - name: Push release commit and tag
        run: |
          # Create and push a release branch
          git checkout -b release/${{ steps.release_version.outputs.release_version }}
          git push origin release/${{ steps.release_version.outputs.release_version }}
          git push origin "v${{ steps.release_version.outputs.release_version }}"
          echo "::notice::Please open a pull request from release/${{ steps.release_version.outputs.release_version }} to main."

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.release_version.outputs.release_version }}"
          name: "Release ${{ steps.release_version.outputs.release_version }}"
          body: "Release version ${{ steps.release_version.outputs.release_version }}"
          draft: false
          prerelease: false

  next-dev:
    name: Set Next Development Version
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'next-dev'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          fetch-tags: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Determine next development version
        id: next_version
        run: |
          if [ -n "${{ github.event.inputs.next_version }}" ]; then
            NEXT_VERSION="${{ github.event.inputs.next_version }}"
          else
            # Auto-increment patch version
            CURRENT="${{ steps.current_version.outputs.current_version }}"
            # Increment patch version (e.g., 0.3.0 -> 0.3.1)
            MAJOR=$(echo "$CURRENT" | cut -d. -f1)
            MINOR=$(echo "$CURRENT" | cut -d. -f2)
            PATCH=$(echo "$CURRENT" | cut -d. -f3)
            PATCH=$((PATCH + 1))
            NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next development version: $NEXT_VERSION"

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Set next development version
        run: |
          NEXT="${{ steps.next_version.outputs.next_version }}"
          # Update version in Cargo.toml
          sed -i.bak "s/^version = \".*\"/version = \"$NEXT\"/" Cargo.toml
          rm Cargo.toml.bak

      - name: Commit next development version
        run: |
          git add Cargo.toml Cargo.lock
          git commit -m "[CI] Set next development version ${{ steps.next_version.outputs.next_version }}"
          # Create and push a release branch
          git checkout -b release/next-dev-${{ steps.next_version.outputs.next_version }}
          git push origin release/next-dev-${{ steps.next_version.outputs.next_version }}
          echo "::notice::Please open a pull request from release/next-dev-${{ steps.next_version.outputs.next_version }} to main."
