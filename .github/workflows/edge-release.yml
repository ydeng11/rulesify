name: Edge Release

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  create-edge-release:
    name: Create Edge Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR number or identifier
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_identifier=pr${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # For merge_group, use commit SHA
            COMMIT_SHA=$(git rev-parse --short HEAD)
            echo "pr_number=edge" >> $GITHUB_OUTPUT
            echo "pr_identifier=$COMMIT_SHA" >> $GITHUB_OUTPUT
          fi

      - name: Get commit SHA
        id: commit
        run: |
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT

      - name: Create or update edge release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          TAG_NAME="edge-${{ steps.pr.outputs.pr_identifier }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            RELEASE_NAME="Edge Release (PR #${{ steps.pr.outputs.pr_number }})"
            RELEASE_BODY="Edge release for PR #${{ steps.pr.outputs.pr_number }}

          Commit: ${{ steps.commit.outputs.sha }}
          Branch: ${{ github.head_ref }}"
          else
            RELEASE_NAME="Edge Release (${{ steps.commit.outputs.sha }})"
            RELEASE_BODY="Edge release for merge group

          Commit: ${{ steps.commit.outputs.sha }}"
          fi

          # Check if release exists, delete it first to avoid conflicts
          if gh release view "$TAG_NAME" &>/dev/null; then
            echo "Release $TAG_NAME already exists, deleting..."
            gh release delete "$TAG_NAME" --yes || true
          fi

          # Create new release (will be populated by build jobs)
          gh release create "$TAG_NAME" \
            --title "$RELEASE_NAME" \
            --notes "$RELEASE_BODY" \
            --draft=false \
            --prerelease=true || echo "Release may already exist from concurrent job"

  build-and-release-edge:
    name: Build and Release Edge
    needs: create-edge-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: rulesify
            asset_name: rulesify-linux-amd64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: rulesify
            asset_name: rulesify-darwin-amd64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: rulesify
            asset_name: rulesify-darwin-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: rulesify.exe
            asset_name: rulesify-windows-amd64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Get PR number or identifier
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_identifier=pr${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            # For merge_group, use commit SHA
            COMMIT_SHA=$(git rev-parse --short HEAD)
            echo "pr_number=edge" >> $GITHUB_OUTPUT
            echo "pr_identifier=$COMMIT_SHA" >> $GITHUB_OUTPUT
          fi

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package Binary and Generate Checksum
        shell: bash
        run: |
          cd target/${{ matrix.target }}/release
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a ../../../${{ matrix.asset_name }}.zip ${{ matrix.artifact_name }}
            certutil -hashfile ../../../${{ matrix.asset_name }}.zip SHA256 > ../../../${{ matrix.asset_name }}.zip.sha256
          else
            tar -czf ../../../${{ matrix.asset_name }}.tar.gz ${{ matrix.artifact_name }}
            shasum -a 256 ../../../${{ matrix.asset_name }}.tar.gz > ../../../${{ matrix.asset_name }}.tar.gz.sha256
          fi
          cd -

      - name: Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          TAG_NAME="edge-${{ steps.pr.outputs.pr_identifier }}"
          # Retry logic for concurrent uploads
          MAX_RETRIES=5
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
              if gh release upload "$TAG_NAME" ${{ matrix.asset_name }}.zip --clobber 2>/dev/null; then
                break
              fi
            else
              if gh release upload "$TAG_NAME" ${{ matrix.asset_name }}.tar.gz --clobber 2>/dev/null; then
                break
              fi
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Upload failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
            sleep 2
          done

      - name: Upload Checksum
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          TAG_NAME="edge-${{ steps.pr.outputs.pr_identifier }}"
          # Retry logic for concurrent uploads
          MAX_RETRIES=5
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
              if gh release upload "$TAG_NAME" ${{ matrix.asset_name }}.zip.sha256 --clobber 2>/dev/null; then
                break
              fi
            else
              if gh release upload "$TAG_NAME" ${{ matrix.asset_name }}.tar.gz.sha256 --clobber 2>/dev/null; then
                break
              fi
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Upload failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
            sleep 2
          done
